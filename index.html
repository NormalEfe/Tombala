<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Yƒ±lba≈üƒ± Tombalasƒ± (Otomatik)</title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --felt-green: #0b4625;
            --wood-dark: #3e2723;
            --gold: #ffd700;
            --btn-ready: #27ae60;
            --btn-wait: #95a5a6;
        }

        body {
            margin: 0;
            font-family: 'Roboto Condensed', sans-serif;
            background-color: var(--felt-green);
            background-image: url("https://www.transparenttextures.com/patterns/felt.png");
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* Aray√ºz */
        .screen { display: none; height: 100%; width: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; top:0; left:0; }
        .screen.active { display: flex; z-index: 10; }

        .panel {
            background: rgba(0, 0, 0, 0.7);
            padding: 2rem;
            border-radius: 15px;
            border: 2px solid var(--gold);
            text-align: center;
            backdrop-filter: blur(5px);
            width: 90%; max-width: 400px;
        }

        input { padding: 15px; border-radius: 5px; border: none; font-size: 1.2rem; margin: 10px 0; width: 80%; text-align: center; }
        
        button {
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
            color: white; border: none; padding: 12px 25px;
            font-size: 1.1rem; border-radius: 50px; cursor: pointer;
            margin: 5px; font-weight: bold;
            box-shadow: 0 4px 0 #922b21;
            transition: 0.1s;
        }
        button:active { transform: translateY(4px); box-shadow: none; }
        button.secondary { background: linear-gradient(to bottom, #3498db, #2980b9); box-shadow: 0 4px 0 #1f618d; }
        
        /* OYUNCU HAZIR BUTONU */
        #btn-player-ready {
            background: var(--btn-ready); box-shadow: 0 4px 0 #1e8449;
            width: 90%; padding: 15px; font-size: 1.3rem; margin-top: 10px;
        }
        #btn-player-ready:disabled {
            background: var(--btn-wait); box-shadow: none; cursor: not-allowed; opacity: 0.7;
        }

        /* OYUN ALANI */
        #game-header {
            width: 100%; padding: 10px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.4); height: 50px; box-sizing: border-box;
        }

        .card-frame {
            background: #fff; padding: 5px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); width: 95%; max-width: 500px; margin: 10px auto;
        }
        .card-row { display: grid; grid-template-columns: repeat(9, 1fr); border: 1px solid #333; }
        .cell {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            border-right: 1px solid #333; font-size: 1.2rem; color: #333; position: relative;
            background: url('https://www.transparenttextures.com/patterns/cardboard.png');
        }
        .cell:last-child { border-right: none; }
        .cell.empty { background: #ddd; }
        
        .chip {
            position: absolute; width: 80%; height: 80%; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(41, 128, 185, 0.9), rgba(21, 67, 96, 0.9));
            display: none; border: 2px solid rgba(255,255,255,0.3);
        }
        .cell.marked .chip { display: block; animation: drop 0.2s; }
        @keyframes drop { 0% { transform: scale(3); opacity:0; } 100% { transform: scale(1); opacity:1; } }

        /* HOST */
        .drawn-token {
            width: 120px; height: 120px; background: #f4d03f; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 4rem; color: #3e2723; border: 6px solid #b7950b;
            margin: 20px auto; animation: pop 0.5s;
        }
        @keyframes pop { 0% { transform: scale(0) rotate(-180deg); } 100% { transform: scale(1); } }
        
        .ready-bar {
            width: 80%; background: #333; height: 20px; border-radius: 10px; margin: 10px auto; overflow: hidden; position: relative;
        }
        .ready-fill {
            height: 100%; background: #27ae60; width: 0%; transition: width 0.3s;
        }
        .ready-text { position: absolute; width: 100%; text-align: center; top:0; font-size: 0.8rem; line-height: 20px; }

        /* Master Board */
        .master-board { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; max-width: 400px; margin: 0 auto; }
        .mb-cell { width: 20px; height: 20px; background: rgba(255,255,255,0.1); font-size: 0.6rem; display: flex; align-items: center; justify-content: center; border-radius: 3px;}
        .mb-cell.active { background: #f4d03f; color: #000; font-weight: bold; }

        /* Overlay */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:100; display:none; flex-direction:column; align-items:center; justify-content:center; text-align: center; }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <div class="panel">
            <h1 style="margin:0; color:var(--gold);">üéÑ TOMBALA üéÑ</h1>
            <p>Pro & Otomatik Mod</p>
            <input type="text" id="username" placeholder="Adƒ±n nedir?">
            <br>
            <button onclick="goToLobby()">Giri≈ü</button>
        </div>
    </div>

    <div id="screen-lobby" class="screen">
        <div class="panel">
            <h2>Ho≈ügeldin <span id="lobby-name" style="color:var(--gold)"></span></h2>
            <button onclick="createRoom()">üëë Oda Kur</button>
            <div style="margin:15px; border-bottom:1px solid #555;"></div>
            <input type="number" id="join-code" placeholder="Oda Kodu">
            <button class="secondary" onclick="joinRoom()">Katƒ±l</button>
        </div>
    </div>

    <div id="screen-host-wait" class="screen">
        <div class="panel">
            <h3>Oda Kodu:</h3>
            <div style="font-size:3rem; color:var(--gold); letter-spacing:5px;" id="host-code-display">...</div>
            <p>Oyuncular:</p>
            <ul id="host-player-list" style="list-style:none; padding:0; color:#2ecc71;"></ul>
            <button onclick="startGameHost()">Ba≈ülat üöÄ</button>
        </div>
    </div>

    <div id="screen-player-wait" class="screen">
        <div class="panel">
            <h2>Bekleniyor...</h2>
            <p>Oda sahibi ba≈ülatƒ±nca oyun a√ßƒ±lacak.</p>
        </div>
    </div>

    <div id="screen-game-host" class="screen">
        <div id="game-header">Host Paneli <span id="bag-count">90</span></div>
        <div style="flex:1; width:100%; text-align:center;">
            <div id="current-token" class="drawn-token">?</div>
            
            <div class="ready-bar">
                <div id="ready-fill" class="ready-fill"></div>
                <div id="ready-text" class="ready-text">0/0 Hazƒ±r</div>
            </div>

            <button onclick="forceDraw()" id="btn-force" style="margin-top:10px;">Zorla Deƒüi≈ütir üé≤</button>
            
            <div style="margin-top:15px; font-size:0.8rem;">√áƒ±kan Sayƒ±lar:</div>
            <div class="master-board" id="master-board"></div>
        </div>
    </div>

    <div id="screen-game-player" class="screen">
        <div id="game-header">
            <span id="room-info">Oda: --</span>
            <span id="last-num" style="font-size:1.5rem; color:var(--gold); font-weight:bold;">--</span>
        </div>
        
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%;">
            <div class="card-frame" id="my-card"></div>
            
            <button id="btn-player-ready" onclick="iAmReady()">HAZIRIM (Sƒ±radaki) üëç</button>

            <div style="display:flex; margin-top:10px; gap:5px;">
                <button class="action-btn" onclick="claimWin(1)">1.√áƒ∞NKO</button>
                <button class="action-btn" onclick="claimWin(2)">2.√áƒ∞NKO</button>
                <button class="action-btn secondary" onclick="claimWin(3)">TOMBALA</button>
            </div>
        </div>
    </div>

    <div id="screen-fail" class="overlay">
        <h1 style="color:red; font-size:4rem;">ELENDƒ∞N!</h1>
        <p>√áƒ±kmayan sayƒ±ya bastƒ±n.</p>
        <button onclick="location.reload()">√áƒ±kƒ±≈ü</button>
    </div>

    <script>
        // --- DEƒûƒ∞≈ûKENLER ---
        let peer = null;
        let conn = null; 
        let connections = []; // Host i√ßin oyuncu listesi
        let readyStatus = {}; // {peerId: true/false}
        
        let myName = "";
        let amIHost = false;
        let bag = [];
        let drawnNumbers = [];
        let myCardNumbers = [];
        let currentCinkoLevel = 0;

        // --- SES ---
        function speak(num) {
            if('speechSynthesis' in window){
                const u = new SpeechSynthesisUtterance(num);
                u.lang='tr-TR'; u.rate=1; window.speechSynthesis.speak(u);
            }
        }

        // --- NAV ---
        function show(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function goToLobby(){ 
            const n = document.getElementById('username').value.trim();
            if(!n) return alert("ƒ∞sim gir!");
            myName = n; document.getElementById('lobby-name').innerText=n; show('screen-lobby');
        }

        // --- HOST LOGIC ---
        function createRoom(){
            amIHost = true;
            const code = Math.floor(1000 + Math.random()*9000);
            peer = new Peer('tombala-auto-'+code);
            peer.on('open', ()=>{
                document.getElementById('host-code-display').innerText=code;
                show('screen-host-wait');
                initBoard();
            });
            peer.on('connection', c=>{
                connections.push(c);
                readyStatus[c.peer] = false; // Ba≈ülangƒ±√ßta hazƒ±r deƒüil
                c.on('data', d => handleHostData(c, d));
                c.on('close', () => {
                    connections = connections.filter(x => x.peer !== c.peer);
                    delete readyStatus[c.peer];
                    updateReadyUI(); // Biri d√º≈üerse sayƒ±yƒ± g√ºncelle
                });
            });
            peer.on('error', ()=>alert("Hata: Kod dolu."));
        }

        function initBoard(){
            const b = document.getElementById('master-board'); b.innerHTML='';
            for(let i=1; i<=90; i++){
                const d=document.createElement('div'); d.className='mb-cell'; d.id='mb-'+i; d.innerText=i; b.appendChild(d);
            }
            bag = Array.from({length:90}, (_,i)=>i+1);
        }

        function startGameHost(){
            show('screen-game-host');
            broadcast({type:'START'});
            setTimeout(drawNumber, 1000); // 1sn sonra ilk sayƒ±
        }

        function handleHostData(conn, data){
            if(data.type==='JOIN'){
                const li=document.createElement('li'); li.innerText=data.name; 
                document.getElementById('host-player-list').appendChild(li);
                conn.playerName = data.name;
            }
            if(data.type==='READY'){
                readyStatus[conn.peer] = true;
                updateReadyUI();
                checkAllReady();
            }
            if(data.type==='CLAIM'){
                // Hile Kontrol
                let valid = data.rows.every(n => drawnNumbers.includes(n));
                if(valid){
                    broadcast({type:'WIN', msg: data.name + " " + data.lvl + " YAPTI! üéâ"});
                    confetti();
                } else {
                    conn.send({type:'FAIL'}); // Sadece ona
                    broadcast({type:'WIN', msg: "‚ö†Ô∏è " + data.name + " YANLI≈û BASTI VE ELENDƒ∞!"});
                }
            }
        }

        function updateReadyUI(){
            const total = connections.length;
            const readyCount = Object.values(readyStatus).filter(x=>x).length;
            const pct = total === 0 ? 0 : (readyCount / total) * 100;
            
            document.getElementById('ready-fill').style.width = pct + "%";
            document.getElementById('ready-text').innerText = `${readyCount}/${total} Hazƒ±r`;
        }

        function checkAllReady(){
            if(connections.length === 0) return;
            const allReady = Object.values(readyStatus).every(x=>x === true);
            // Eƒüer herkes hazƒ±rsa ve en az 1 oyuncu varsa
            if(allReady && connections.length > 0){
                setTimeout(drawNumber, 500); // Yarƒ±m saniye bekle ve √ßek
            }
        }

        function drawNumber(){
            if(bag.length===0) return alert("Oyun Bitti");
            const idx = Math.floor(Math.random()*bag.length);
            const num = bag[idx];
            bag.splice(idx,1);
            drawnNumbers.push(num);

            // UI Host
            document.getElementById('current-token').innerText = num;
            document.getElementById('mb-'+num).classList.add('active');
            document.getElementById('bag-count').innerText = bag.length;
            speak(num);

            // Reset Ready Status
            connections.forEach(c => readyStatus[c.peer] = false);
            updateReadyUI();

            // Send to players
            broadcast({type:'NUMBER', val:num});
        }
        
        function forceDraw(){
            if(confirm("Herkes hazƒ±r deƒüil. Yine de √ßekilsin mi?")) drawNumber();
        }

        function broadcast(msg){ connections.forEach(c=>c.send(msg)); }

        // --- PLAYER LOGIC ---
        function joinRoom(){
            const code = document.getElementById('join-code').value;
            if(!code) return alert("Kod gir");
            amIHost = false;
            peer = new Peer();
            peer.on('open', id=>{
                conn = peer.connect('tombala-auto-'+code);
                conn.on('open', ()=>{
                    show('screen-player-wait');
                    conn.send({type:'JOIN', name:myName});
                });
                conn.on('data', handlePlayerData);
                conn.on('close', ()=>alert("Host ayrƒ±ldƒ±."));
            });
        }

        function handlePlayerData(data){
            if(data.type==='START'){
                generateCard();
                show('screen-game-player');
            }
            if(data.type==='NUMBER'){
                document.getElementById('last-num').innerText = data.val;
                speak(data.val);
                // Yeni sayƒ± geldi, butonu aktif et
                const btn = document.getElementById('btn-player-ready');
                btn.disabled = false;
                btn.innerText = "HAZIRIM (Sƒ±radaki) üëç";
                btn.style.background = "#27ae60";
            }
            if(data.type==='WIN') { alert(data.msg); confetti(); }
            if(data.type==='FAIL') { document.getElementById('screen-fail').style.display='flex'; }
        }

        function iAmReady(){
            // Butonu pasife √ßek
            const btn = document.getElementById('btn-player-ready');
            btn.disabled = true;
            btn.innerText = "Diƒüerleri Bekleniyor... ‚è≥";
            btn.style.background = "#95a5a6";
            
            conn.send({type:'READY'});
        }

        function generateCard(){
            const c = document.getElementById('my-card'); c.innerHTML='';
            myCardNumbers = [];
            for(let r=0; r<3; r++){
                let row = Array(9).fill(null);
                let cols = [];
                while(cols.length<5){
                    let x = Math.floor(Math.random()*9); if(!cols.includes(x)) cols.push(x);
                }
                cols.forEach(col=>{
                    let min = col===0?1:col*10; let max=col===8?90:(col*10)+9;
                    let n; 
                    do{ n = Math.floor(Math.random()*(max-min+1))+min; } while(myCardNumbers.flat().includes(n));
                    row[col]=n;
                });
                myCardNumbers.push(row);

                // HTML
                const rd = document.createElement('div'); rd.className='card-row';
                row.forEach(val=>{
                    const cell = document.createElement('div');
                    if(val===null) cell.className='cell empty';
                    else {
                        cell.className='cell'; cell.innerText=val;
                        const ch = document.createElement('div'); ch.className='chip'; cell.appendChild(ch);
                        cell.onclick=()=>{
                            cell.classList.toggle('marked');
                        };
                    }
                    rd.appendChild(cell);
                });
                c.appendChild(rd);
            }
        }

        function claimWin(lvl){
            if(lvl <= currentCinkoLevel) return alert("Bunu zaten aldƒ±n!");
            // Check rows locally simply to gather numbers
            const rows = document.querySelectorAll('.card-row');
            let markedNums = [];
            rows.forEach(r=>{
                if(r.querySelectorAll('.cell.marked').length===5){
                    r.querySelectorAll('.cell.marked').forEach(c=>markedNums.push(parseInt(c.innerText)));
                }
            });
            if(markedNums.length===0) return alert("Tamamlanmƒ±≈ü satƒ±r yok!");
            
            conn.send({type:'CLAIM', rows:markedNums, lvl:lvl, name:myName});
        }
    </script>
</body>
</html>

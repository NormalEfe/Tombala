<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yƒ±lba≈üƒ± Tombalasƒ±</title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --felt-green: #0b4625;
            --gold: #ffd700;
            --btn-ready: #27ae60;
            --btn-wait: #7f8c8d;
            --host-panel-bg: rgba(0, 0, 0, 0.5);
        }

        body {
            margin: 0;
            font-family: 'Roboto Condensed', sans-serif;
            background-color: var(--felt-green);
            background-image: url("https://www.transparenttextures.com/patterns/felt.png");
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* --- ARAY√úZ --- */
        .screen { display: none; height: 100%; width: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; top:0; left:0; }
        .screen.active { display: flex; z-index: 10; }

        .panel {
            background: rgba(0, 0, 0, 0.8);
            padding: 2rem;
            border-radius: 15px;
            border: 2px solid var(--gold);
            text-align: center;
            backdrop-filter: blur(5px);
            width: 90%; max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        input { padding: 15px; border-radius: 5px; border: none; font-size: 1.2rem; margin: 10px 0; width: 80%; text-align: center; }
        
        button {
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
            color: white; border: none; padding: 12px 20px;
            font-size: 1rem; border-radius: 50px; cursor: pointer;
            margin: 5px; font-weight: bold;
            box-shadow: 0 4px 0 #922b21;
            transition: 0.1s;
        }
        button:active { transform: translateY(4px); box-shadow: none; }
        button.secondary { background: linear-gradient(to bottom, #3498db, #2980b9); box-shadow: 0 4px 0 #1f618d; }
        
        /* OYUNCU HAZIR BUTONU */
        #btn-player-ready {
            background: var(--btn-ready); box-shadow: 0 4px 0 #1e8449;
            width: 90%; padding: 15px; font-size: 1.3rem; margin-top: 10px;
        }
        #btn-player-ready:disabled {
            background: var(--btn-wait); box-shadow: none; cursor: not-allowed; opacity: 0.8; color: #ddd;
        }

        /* OYUN EKRANI */
        #game-header {
            width: 100%; padding: 5px 15px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.4); height: 50px; box-sizing: border-box;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* Host √ñzel Alanƒ± */
        #host-controls-area {
            display: none; /* Sadece host g√∂recek */
            width: 100%; background: var(--host-panel-bg);
            padding: 5px; box-sizing: border-box;
            border-bottom: 1px dashed #555;
            text-align: center;
        }
        .ready-bar {
            width: 90%; background: #333; height: 10px; border-radius: 5px; margin: 5px auto; overflow: hidden;
        }
        .ready-fill { height: 100%; background: #2ecc71; width: 0%; transition: width 0.3s; }

        /* KART */
        .card-frame {
            background: #fff; padding: 5px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); width: 95%; max-width: 500px; margin: 10px auto;
        }
        .card-row { display: grid; grid-template-columns: repeat(9, 1fr); border: 1px solid #333; }
        .cell {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            border-right: 1px solid #333; font-size: 1.1rem; color: #333; position: relative;
            background: url('https://www.transparenttextures.com/patterns/cardboard.png');
        }
        .cell:last-child { border-right: none; }
        .cell.empty { background: #ddd; }
        
        .chip {
            position: absolute; width: 85%; height: 85%; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(41, 128, 185, 0.9), rgba(21, 67, 96, 0.9));
            display: none; border: 2px solid rgba(255,255,255,0.3); box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }
        .cell.marked .chip { display: block; animation: drop 0.2s; }
        @keyframes drop { 0% { transform: scale(3); opacity:0; } 100% { transform: scale(1); opacity:1; } }

        /* Master Board (Host i√ßin altta minik) */
        #master-board {
            display: none; grid-template-columns: repeat(15, 1fr); gap: 2px; 
            margin: 5px auto; max-width: 95%; opacity: 0.7;
        }
        .mb-cell { width: 100%; aspect-ratio: 1; background: rgba(255,255,255,0.1); font-size: 0.5rem; display: flex; align-items: center; justify-content: center; border-radius: 2px;}
        .mb-cell.active { background: var(--gold); color: #000; font-weight: bold; }

        /* Overlay */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:100; display:none; flex-direction:column; align-items:center; justify-content:center; text-align: center; }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <div class="panel">
            <h1 style="margin:0; color:var(--gold);">üéÑ TOMBALA 2025</h1>
            <p>Herkes Oynuyor Modu</p>
            <input type="text" id="username" placeholder="Adƒ±n nedir?">
            <br>
            <button onclick="goToLobby()">Giri≈ü</button>
        </div>
    </div>

    <div id="screen-lobby" class="screen">
        <div class="panel">
            <h2>Ho≈ügeldin <span id="lobby-name" style="color:var(--gold)"></span></h2>
            <button onclick="createRoom()">üëë Oda Kur</button>
            <div style="margin:15px; border-bottom:1px solid #555;"></div>
            <input type="number" id="join-code" placeholder="Oda Kodu">
            <button class="secondary" onclick="joinRoom()">Katƒ±l</button>
        </div>
    </div>

    <div id="screen-host-wait" class="screen">
        <div class="panel">
            <h3>Oda Kodu:</h3>
            <div style="font-size:3rem; color:var(--gold); letter-spacing:5px;" id="host-code-display">...</div>
            <p>Baƒülananlar:</p>
            <ul id="host-player-list" style="list-style:none; padding:0; color:#2ecc71;"></ul>
            <button onclick="startGame()">Herkes Geldiyse BA≈ûLA üöÄ</button>
        </div>
    </div>

    <div id="screen-player-wait" class="screen">
        <div class="panel">
            <h2>Bekleniyor...</h2>
            <p>Oda sahibi oyunu ba≈ülatƒ±nca kartƒ±n g√∂r√ºnecek.</p>
        </div>
    </div>

    <div id="screen-game" class="screen">
        
        <div id="game-header">
            <span id="room-info">Oda: --</span>
            <div style="text-align: right;">
                <span style="font-size:0.7rem; display:block;">SON SAYI</span>
                <span id="last-num" style="font-size:1.5rem; color:var(--gold); font-weight:bold;">--</span>
            </div>
        </div>

        <div id="host-controls-area">
            <div style="display:flex; justify-content: space-between; align-items: center; padding: 0 10px;">
                <span style="font-size:0.8rem;">Y√∂netici Paneli</span>
                <button onclick="forceDraw()" style="font-size:0.8rem; padding: 5px 10px; background:#e67e22;">‚ö†Ô∏è Zorla √áek</button>
            </div>
            <div class="ready-bar">
                <div id="ready-fill" class="ready-fill"></div>
            </div>
            <div style="font-size:0.7rem; color:#aaa;" id="ready-text">0/0 Hazƒ±r</div>
        </div>
        
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%;">
            
            <div class="card-frame" id="my-card"></div>
            
            <button id="btn-player-ready" onclick="iAmReady()">HAZIRIM (Sƒ±radaki) üëç</button>

            <div style="display:flex; margin-top:10px; gap:5px;">
                <button class="action-btn" onclick="claimWin(1)">1.√áƒ∞NKO</button>
                <button class="action-btn" onclick="claimWin(2)">2.√áƒ∞NKO</button>
                <button class="action-btn secondary" onclick="claimWin(3)">TOMBALA</button>
            </div>

            <div id="master-board"></div>
        </div>
    </div>

    <div id="screen-fail" class="overlay">
        <h1 style="color:red; font-size:4rem;">ELENDƒ∞N!</h1>
        <p>√áƒ±kmayan sayƒ±ya bastƒ±n.</p>
        <button onclick="location.reload()">√áƒ±kƒ±≈ü</button>
    </div>

    <script>
        // --- DEƒûƒ∞≈ûKENLER ---
        let peer = null;
        let conn = null; // Player i√ßin host baƒülantƒ±sƒ±
        let connections = []; // Host i√ßin oyuncu listesi
        let readyStatus = {}; // {peerId: true/false} (Host i√ßin √∂zel key: 'HOST')
        
        let myName = "";
        let amIHost = false;
        let bag = [];
        let drawnNumbers = [];
        let myCardNumbers = [];
        let currentCinkoLevel = 0;
        let hostReady = false; // Hostun kendi hazƒ±r durumu

        // --- SES ---
        function speak(num) {
            if('speechSynthesis' in window){
                const u = new SpeechSynthesisUtterance(num);
                u.lang='tr-TR'; u.rate=1; window.speechSynthesis.speak(u);
            }
        }

        // --- EKRAN Y√ñNETƒ∞Mƒ∞ ---
        function show(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function goToLobby(){ 
            const n = document.getElementById('username').value.trim();
            if(!n) return alert("ƒ∞sim gir!");
            myName = n; document.getElementById('lobby-name').innerText=n; show('screen-lobby');
        }

        // --- HOST MANTIƒûI ---
        function createRoom(){
            amIHost = true;
            const code = Math.floor(1000 + Math.random()*9000);
            peer = new Peer('tombala-final-'+code);
            peer.on('open', ()=>{
                document.getElementById('host-code-display').innerText=code;
                show('screen-host-wait');
                initBoard();
                
                // Host listeye kendini de eklesin g√∂rsel olarak
                const li=document.createElement('li'); li.innerText=myName + " (Sen)"; 
                document.getElementById('host-player-list').appendChild(li);
            });
            
            peer.on('connection', c=>{
                connections.push(c);
                readyStatus[c.peer] = false;
                c.on('data', d => handleHostData(c, d));
                c.on('close', () => {
                    connections = connections.filter(x => x.peer !== c.peer);
                    delete readyStatus[c.peer];
                    updateReadyUI();
                });
            });
            peer.on('error', ()=>alert("Hata: Kod dolu."));
        }

        function initBoard(){
            const b = document.getElementById('master-board'); b.innerHTML='';
            for(let i=1; i<=90; i++){
                const d=document.createElement('div'); d.className='mb-cell'; d.id='mb-'+i; d.innerText=i; b.appendChild(d);
            }
            bag = Array.from({length:90}, (_,i)=>i+1);
        }

        function startGame(){
            // Host olarak oyunu ba≈ülat
            show('screen-game');
            // Host aray√ºz√ºn√º a√ß
            document.getElementById('host-controls-area').style.display = 'block';
            document.getElementById('master-board').style.display = 'grid';
            document.getElementById('room-info').innerText = "Y√∂netici";
            
            // Host Kartƒ±nƒ± Olu≈ütur
            generateCard();
            
            // Oyunculara Ba≈ülat Komutu Ver
            broadcast({type:'START'});
            
            setTimeout(drawNumber, 1500); // Biraz bekle ilk sayƒ± gelsin
        }

        // Hostun veri i≈ülemesi (Oyunculardan gelen)
        function handleHostData(conn, data){
            if(data.type==='JOIN'){
                const li=document.createElement('li'); li.innerText=data.name; 
                document.getElementById('host-player-list').appendChild(li);
                conn.playerName = data.name;
            }
            if(data.type==='READY'){
                readyStatus[conn.peer] = true;
                updateReadyUI();
                checkAllReady();
            }
            if(data.type==='CLAIM'){
                // Hile Kontrol√º
                let valid = data.rows.every(n => drawnNumbers.includes(n));
                if(valid){
                    broadcast({type:'WIN', msg: data.name + " " + data.lvl + " YAPTI! üéâ"});
                    confetti();
                } else {
                    conn.send({type:'FAIL'}); // Sadece ona
                    broadcast({type:'WIN', msg: "‚ò†Ô∏è " + data.name + " YANLI≈û BASTI VE ELENDƒ∞!"});
                }
            }
        }

        // Hostun kendi hazƒ±r olma durumu
        function iAmReadyHost(){
            hostReady = true;
            const btn = document.getElementById('btn-player-ready');
            btn.disabled = true;
            btn.innerText = "Diƒüerleri Bekleniyor... ‚è≥";
            
            updateReadyUI();
            checkAllReady();
        }

        function updateReadyUI(){
            // Host + Oyuncular
            const total = connections.length + 1; 
            const readyCount = Object.values(readyStatus).filter(x=>x).length + (hostReady ? 1 : 0);
            
            const pct = (readyCount / total) * 100;
            document.getElementById('ready-fill').style.width = pct + "%";
            document.getElementById('ready-text').innerText = `${readyCount}/${total} Hazƒ±r`;
        }

        function checkAllReady(){
            const allPeersReady = Object.values(readyStatus).every(x=>x === true);
            // Host da hazƒ±rsa ve herkes hazƒ±rsa
            if(hostReady && allPeersReady){
                setTimeout(drawNumber, 500);
            }
        }

        function drawNumber(){
            if(bag.length===0) return alert("Oyun Bitti");
            const idx = Math.floor(Math.random()*bag.length);
            const num = bag[idx];
            bag.splice(idx,1);
            drawnNumbers.push(num);

            // HOST ƒ∞√áƒ∞N G√úNCELLEME
            document.getElementById('last-num').innerText = num;
            document.getElementById('mb-'+num).classList.add('active');
            speak(num);

            // Host Butonunu Sƒ±fƒ±rla
            hostReady = false;
            const btn = document.getElementById('btn-player-ready');
            btn.disabled = false;
            btn.innerText = "HAZIRIM (Sƒ±radaki) üëç";
            btn.style.background = "#27ae60";

            // Oyuncularƒ± Sƒ±fƒ±rla
            connections.forEach(c => readyStatus[c.peer] = false);
            updateReadyUI();

            // Oyunculara G√∂nder
            broadcast({type:'NUMBER', val:num});
        }
        
        function forceDraw(){
            if(confirm("Herkes hazƒ±r deƒüil. Yine de √ßekilsin mi?")) drawNumber();
        }

        function broadcast(msg){ connections.forEach(c=>c.send(msg)); }


        // --- OYUNCU (PLAYER) MANTIƒûI ---
        function joinRoom(){
            const code = document.getElementById('join-code').value;
            if(!code) return alert("Kod gir");
            amIHost = false;
            peer = new Peer();
            peer.on('open', id=>{
                conn = peer.connect('tombala-final-'+code);
                conn.on('open', ()=>{
                    show('screen-player-wait');
                    conn.send({type:'JOIN', name:myName});
                });
                conn.on('data', handlePlayerData);
                conn.on('close', ()=>alert("Host ayrƒ±ldƒ±."));
            });
        }

        function handlePlayerData(data){
            if(data.type==='START'){
                generateCard();
                show('screen-game');
                // Host kontrollerini gizle (garanti olsun)
                document.getElementById('host-controls-area').style.display = 'none';
                document.getElementById('master-board').style.display = 'none';
            }
            if(data.type==='NUMBER'){
                document.getElementById('last-num').innerText = data.val;
                speak(data.val);
                
                // Butonu Aktif Et
                const btn = document.getElementById('btn-player-ready');
                btn.disabled = false;
                btn.innerText = "HAZIRIM (Sƒ±radaki) üëç";
                btn.style.background = "#27ae60";
            }
            if(data.type==='WIN') { alert(data.msg); confetti(); }
            if(data.type==='FAIL') { document.getElementById('screen-fail').style.display='flex'; }
        }

        // --- ORTAK FONKSƒ∞YONLAR ---
        function iAmReady(){
            if(amIHost) {
                iAmReadyHost();
            } else {
                // Player Ready
                const btn = document.getElementById('btn-player-ready');
                btn.disabled = true;
                btn.innerText = "Diƒüerleri Bekleniyor... ‚è≥";
                btn.style.background = "#7f8c8d";
                conn.send({type:'READY'});
            }
        }

        function generateCard(){
            const c = document.getElementById('my-card'); c.innerHTML='';
            myCardNumbers = [];
            for(let r=0; r<3; r++){
                let row = Array(9).fill(null);
                let cols = [];
                while(cols.length<5){
                    let x = Math.floor(Math.random()*9); if(!cols.includes(x)) cols.push(x);
                }
                cols.forEach(col=>{
                    let min = col===0?1:col*10; let max=col===8?90:(col*10)+9;
                    let n; 
                    do{ n = Math.floor(Math.random()*(max-min+1))+min; } while(myCardNumbers.flat().includes(n));
                    row[col]=n;
                });
                myCardNumbers.push(row);

                // HTML
                const rd = document.createElement('div'); rd.className='card-row';
                row.forEach(val=>{
                    const cell = document.createElement('div');
                    if(val===null) cell.className='cell empty';
                    else {
                        cell.className='cell'; cell.innerText=val;
                        const ch = document.createElement('div'); ch.className='chip'; cell.appendChild(ch);
                        cell.onclick=()=>{
                            cell.classList.toggle('marked');
                        };
                    }
                    rd.appendChild(cell);
                });
                c.appendChild(rd);
            }
        }

        function claimWin(lvl){
            if(lvl <= currentCinkoLevel) return alert("Bunu zaten aldƒ±n!");
            
            // Kartƒ± Tara
            const rows = document.querySelectorAll('.card-row');
            let markedNums = [];
            rows.forEach(r=>{
                if(r.querySelectorAll('.cell.marked').length===5){
                    r.querySelectorAll('.cell.marked').forEach(c=>markedNums.push(parseInt(c.innerText)));
                }
            });

            if(markedNums.length===0) return alert("Tamamlanmƒ±≈ü satƒ±r yok!");
            
            if(amIHost) {
                // Host kendi kendini kontrol etsin
                let valid = markedNums.every(n => drawnNumbers.includes(n));
                if(valid){
                    alert("SEN " + lvl + ". √áƒ∞NKO YAPTIN! üéâ");
                    broadcast({type:'WIN', msg: "Y√ñNETƒ∞Cƒ∞ " + lvl + ". √áƒ∞NKO YAPTIN! üéâ"});
                    confetti();
                    currentCinkoLevel = lvl;
                } else {
                    document.getElementById('screen-fail').style.display='flex';
                    broadcast({type:'WIN', msg: "‚ò†Ô∏è Y√ñNETƒ∞Cƒ∞ YANLI≈û BASTI VE ELENDƒ∞!"});
                }
            } else {
                // Player Host'a g√∂ndersin
                conn.send({type:'CLAIM', rows:markedNums, lvl:lvl, name:myName});
            }
        }
    </script>
</body>
</html>
